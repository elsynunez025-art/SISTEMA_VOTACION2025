<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Login / Registro</title>
<style>
  body { 
    font-family: Arial; 
    background: #f0f4f8; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
  }
  form { 
    background: white; 
    padding: 25px; 
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
    width: 320px; 
  }
  input, button { 
    width: 100%; 
    padding: 10px; 
    margin: 8px 0; 
    border-radius: 6px; 
    border: 1px solid #ccc; 
    font-size: 1em;
  }
  button { 
    background: #007bff; 
    color: white; 
    font-weight: 700; 
    border: none; 
    cursor: pointer; 
  }
  button:hover { background: #0056b3; }
  .error { color: red; font-weight: 700; margin-top: 10px; }
</style>
</head>
<body>

<form id="loginForm">
  <h2>Registro / Login</h2>
  <input type="text" id="nombre" placeholder="Nombre" required>
  <input type="text" id="apellido" placeholder="Apellido" required>
  <input type="text" id="nacimiento" placeholder="YYYY-MM-DD" maxlength="10" required>
  <input type="email" id="email" placeholder="Email" required>
  <button type="submit">Ingresar</button>
  <div class="error" id="error"></div>
</form>

<script>
const form = document.getElementById("loginForm");
const errorDiv = document.getElementById("error");
const nacimientoInput = document.getElementById("nacimiento");

// Función para agregar guiones automáticamente al escribir la fecha
nacimientoInput.addEventListener("input", function() {
  let val = this.value.replace(/\D/g, '');
  if(val.length > 4 && val[4] !== '-') val = val.slice(0,4) + '-' + val.slice(4);
  if(val.length > 7 && val[7] !== '-') val = val.slice(0,7) + '-' + val.slice(7);
  if(val.length > 10) val = val.slice(0,10);
  this.value = val;
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  errorDiv.textContent = "";

  const nombre = document.getElementById("nombre").value.trim();
  const apellido = document.getElementById("apellido").value.trim();
  const nacimiento = nacimientoInput.value.trim();
  const email = document.getElementById("email").value.trim();

  // Validación de campos vacíos
  if (!nombre || !apellido || !nacimiento || !email) {
    errorDiv.textContent = "Completa todos los campos";
    return;
  }

  // Validación formato fecha YYYY-MM-DD
  const regexFecha = /^\d{4}-\d{2}-\d{2}$/;
  if(!regexFecha.test(nacimiento)){
    errorDiv.textContent = "Fecha inválida. Usa formato YYYY-MM-DD";
    return;
  }

  // Verificar edad >= 18 años
  const fechaNacimiento = new Date(nacimiento);
  const hoy = new Date();
  let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
  const mesDiff = hoy.getMonth() - fechaNacimiento.getMonth();
  if(mesDiff < 0 || (mesDiff === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
    edad--;
  }
  if(edad < 18){
    errorDiv.textContent = "Debes ser mayor de 18 años para votar";
    return;
  }

  try {
    const backendURL = "https://sistema-votacion2025hn.onrender.com"; // URL pública de Render

    // Registrar usuario
    let res = await fetch(`${backendURL}/api/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nombre, apellido, nacimiento, email })
    });
    let data = await res.json();

    if(res.status === 400 && data.message === "Email ya registrado con otros datos"){
      errorDiv.textContent = data.message;
      return;
    }

    // Login
    res = await fetch(`${backendURL}/api/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nombre, apellido, nacimiento, email })
    });
    data = await res.json();

    if(res.ok){
      // Guardar usuario en localStorage
      localStorage.setItem("user", JSON.stringify({
        userId: data.userId,
        name: nombre + " " + apellido,
        email,
        nacimiento
      }));
      window.location.href = "index.html";
    } else {
      errorDiv.textContent = data.message || "Error en login";
    }

  } catch (error) {
    errorDiv.textContent = "Error conectando con el servidor";
    console.error(error);
  }
});
</script>

</body>
</html>
